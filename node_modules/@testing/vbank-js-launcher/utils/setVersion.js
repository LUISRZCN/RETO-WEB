const {exec} = require('child_process');
const fs = require('fs');
const promisify = require('util').promisify;
const readFile = promisify(fs.readFile);
const writeFile = promisify(fs.writeFile);

async function doIt() {

    const isSnapshot = process.argv[2].indexOf('-SNAPSHOT') > 0;
    const version = process.argv[2].split('-')[0];
    const packageFile = __dirname + '/../package.json';
    const data = JSON.parse(await readFile(packageFile));
    exec(`npm view ${data.name}@${version} version`, async (error, stdout, stderr) => {
        if(stdout && !isSnapshot){
            throw `Error. Version ${version} already exists and this is not an SNAPSHOT`
        }

        data.version = version;
        if(isSnapshot) {
            data.version += '-' + Date.now();
        }
        await writeFile(packageFile, JSON.stringify(data, null, 2));
    });
}

doIt();
