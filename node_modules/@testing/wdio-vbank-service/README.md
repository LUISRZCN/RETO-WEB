## Wdio vBank Service

`wdio-vbank-service` allows us to start a [vBank](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/vbank-cloud/browse) server which provides us with service virtualization, so we don't have to depend on the availability of certain environments or worry about certain network configurations.

-----------------------

### 1. Services

It consists of 2 different WebdriverIO services that can be used together:  

---

#### 1.1 VBankLauncher

It launches a server which provides with service virtualization during the e2e testing process.

It may happen that a vBank server has already been started from a different context, meaning that it's not necessary to include *VBankLauncher* as a service integrated with our tests-runner.  

---

#### 1.2 VBankService

When a service response is virtualized by vBank, the data is saved in a .yml file (stub) stored under a folder structure organized by Cucumber scenario.  

Bearing in mind that each Cucumber scenario represents a session, this service is responsable for informing vBank when a session is about to start or finish, apart from setting which mode (record or replay) and features should be active during a tests' execution.

- So, when vBank's *record mode* is active, services' virtualized responses (stubs) from a given scenario are grouped together into the same folder.
- When vBank's *replay mode* is active, services' virtualized responses (stubs) are checked into the folder previously generated when in recording mode.

It's important to note that this service currently works with [CucumberJs](https://github.com/cucumber/cucumber-js) only.

To know more about how vBank works, detailed documentation can be found [here](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/vbank-cloud/browse).  

-----------------------

### 2. Integration with Acis

If you're already using [Acis](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse) to run e2e tests, *wdio-vbank-service* is available by default, and no additional steps are required:

```json
{
    "dependencies": {
        "@testing/acis-v6": "^2.1.6"
    }
}
```  

---

#### 2.1 Configuration

It's mandatory to get the vBank settings data object correctly configured when passing it to the **wdio-config's [configBuild](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse/packages/wdio-config)** method.   

```js
    const recording = false;
```

```js
    exports.config = configBuild({
        ...,
        vbank: {
            workspace: 'stubs/vbank',
            vbankHost: '(?!.*httpbin).*',
            backends: [
                {
                    name: 'httpbin',
                    realUrl: recording && 'https://httpbin.org/',
                    protocol: 'http',
                    port: '5000',
                    cors: {
                        headers: ['x-custom']
                    }
                },
                {
                    name: 'httpbin2',
                    realUrl: recording && 'https://httpbin.org/',
                    protocol: 'https',
                    port:  '5005',
                    cors: {
                        headers: ['x-custom']
                    }
                }
            ],
            recording
            parallel: true
        },
    });
```

More info about the list of properties available to use vBank as service virtualization provider can be found [here](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse/packages/wdio-vbank-service/docs/index.md).

-----------------------

### 3. Integration with other wdio-powered frameworks

If you're using a different WebdriverIO-powered e2e framework but would like to integrate `wdio-vbank-service` as a service, the best way to proceed is by defining the dependency in your project's **package.json** (choose carefully if it should be installed as dependency or devDependency):

```json
{
    "dependencies": {
        "@testing/wdio-vbank-service": "^2.1.6"
    }
}
```

You can simply do it by executing:

```bash
    npm install @testing/wdio-vbank-service
```    

---

#### 3.1 Configuration

The service needs to be added to the **services** list from your project's `wdio.conf.js` file:

```ts
    import { VBankLauncher, VBankService, VBankConfig } from "@testing/wdio-vbank-service";
```  

```ts
    function getVBankConfigurationSettings(recording: boolean) {
        return {
            workspace: 'stubs/vbank',
            vbankHost: '(?!.*httpbin).*',
            backends: [
                {
                    name: 'httpbin',
                    realUrl: recording && 'https://httpbin.org/',
                    protocol: 'http',
                    port: '5000',
                    cors: {
                        headers: ['x-custom']
                    }
                }
            ],
            recording
            parallel: true
        };
    }
```

```ts
    const recording = true;
    const vBankConfig: VBankConfig = getVBankConfigurationSettings(recording);
    const config: Config = {
        vbank: vBankConfig
    };
``` 

```ts
    exports.config = {
        ...,
        services: [
            [VBankLauncher, config],
            [VBankService, config]
        ]
    }
``` 

More info about the list of properties available to use vBank as service virtualization provider can be found **[here](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse/packages/wdio-config)**.

---

Did this documentation fullfilled your expectations? If you miss something, [let us know](mailto:testing.global.group@bbva.com)!