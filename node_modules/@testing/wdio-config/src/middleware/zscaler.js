const http = require('http');

async function isZscaler() {
    return new Promise(resolve => {
        const options = {
            host: process.env.ZSCALER_HOST || '127.0.0.1',
            port: parseInt(process.env.ZSCALER_PORT) || 8999,
            method: 'GET'
        };

        const request = http.request(options, function(response) {
            const zcalerProxy = findProxyAgent(response);

            response.destroy();
            resolve(zcalerProxy);
        });

        request.on('error', function(error) {
            resolve(null);
        });

        request.end();
    });
}

function findProxyAgent(response) {
    if (response.headers['proxy-agent']?.indexOf('Ztunnel') >= 0) {
        return getProxyHost();
    }
}

function getProxyHost() {
    return 'http://localhost:8999';
}

module.exports = { isZscaler }