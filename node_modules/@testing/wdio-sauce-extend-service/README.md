## Wdio Sauce Extend Service

WebdriverIO service that allows us to upload a native application package directly to [Sauce Labs](https://docs.saucelabs.com/) so that the application can be installed in a native device provided by Sauce Labs for tests to be run against it.

** Currently Sauce Labs is in deprecation process. Please, use **[Galatea](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse/README.md#browsersproviders)** instead.

-----------------------

### 1. Installation

The service is compatible to be integrated in any wdio-powered framework prepared to work with custom services.  

#### 1.1 Integration with Acis

If you're already using [Acis](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse) to run e2e tests, *wdio-sauce-extend-service* is available by default and no additional steps are required, apart from setting up the proper options to work directly with Sauce Labs as browsers / mobile platforms provider â€”explained below.  

Acis v6 dependency in package.json:

```json
{
    "dependencies": {
        "@testing/acis-v6": "^2.1.6"
    }
}
```  

---

#### 1.2 Integration with other frameworks

If you're using a different WebdriverIO-powered e2e framework but would like to integrate `wdio-sauce-extend-service` as a service, the best way to proceed is by defining the dependency in your project's **package.json** (choose carefully if it should be installed as dependency or devDependency):

```json
{
    "dependencies": {
        "@testing/wdio-sauce-extend-service": "^2.1.6"
    }
}
```

You can simply do it by executing:

```bash
    npm install @testing/wdio-sauce-extend-service
```    

Additionally, the service needs to be added to the **services** list from your project's `wdio.conf.js` file:

```js
    services: [..., [require('@testing/wdio-sauce-extend-service'), {}]]
```  

-----------------------

### 2. Configuration

To get the service working successfully it's necessary to assure the following is properly configured, but bear in mind that currently Sauce Labs is in deprecation process in favour of [Galatea](https://globaldevtools.bbva.com/bitbucket/projects/BGT/repos/e2e-js-framework/browse/README.md#browsersproviders).

If you have any questions or need credentials to access Galatea or Sauce Labs from Jenkins, contact us via **[Testing Servicedesk](https://globaldevtools.bbva.com/jira/servicedesk/customer/portal/15/group/38)**.  

---

#### 2.1 Sauce Labs credentials are on point

To configure Sauce Labs as browsers / mobile platforms provider it's necessary to have access credentials that can be requested via [Testing Servicedesk](https://globaldevtools.bbva.com/jira/servicedesk/customer/portal/15/group/38).

Once the credentials are on point, it's as simple as defining the following environment variables before executing the tests' runner:

```groovy
    sh 'GRID_TUNNEL=true GRID_USER=bot-saucelabs GRID_PASS=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX npm run test:e2e'
```  

--

* __GRID_USER__

    The user name provided to connect with Sauce Labs.

    Type: `String`  
    Default: *null*  

--

* __GRID_PASS__

    The apikey provided to connect with Sauce Labs.

    Type: `String`  
    Default: *null*  

--

* __GRID_TUNNEL__

    If your application lives in a local or proxied server you'll also need the following in order to grant permission to stablish connection between your server and Sauce Labs:

    - If you're using **WebdriverIO v5**, assign the environment variable **GRID_TUNNEL**=true.
    - If you're using **WebdriverIO v6**, assign the Wdio Config property **[sauceConnect](ttps://globaldevtools.bbva.com/bitbucket/projects/BGT/repose2e-js-framework/browse/packages/wdio-config/docs/wdio.md#sauceconnect)**.

    Type: `Boolean`  
    Default: *false*  

---

#### 2.2 Sauce Labs Capabilities

Sometimes, it may be required to configure some testing environments (browser, mobile app, version...) that are Sauce Labs-specific, but that configuration should be set up without causing undesired behaviours when running tests with other platforms or providers.

For that, a [series of capabilities](https://docs.saucelabs.com/dev/test-configuration-options/) that are exclusive to [Sauce Labs](https://docs.saucelabs.com/) are available:  

--

* `Required` __App__

    To get an application package successfully uploaded to Sauce Labs, it's important to somehow indicate the path where the application package (.apk for Android, .app.zip for iOs) is located within the workspace.
    
    Just set the target path via **app** or **appium:app** capability, as shown in the example below:  
    
    ```js
        exports.device = {
            platformName: "Android",
            app: join(__dirname, "../bin/AndroidWebView.apk"),
            platformVersion: "9",
            deviceName: ".*",
            autoWebview: true,
            maxInstances: 1,
            chromedriverExecutableDir: process.env.CHROME_DRIVER_DIR,
            testobject_api_key: process.env.TEST_OBJECT_API_KEY_ANDROID
        };
    ```  

--

* __tunnelIdentifier__

    Tipically, when the environment variable **GRID_TUNNEL** (or the WebdriverIO property [sauceConnect](ttps://globaldevtools.bbva.com/bitbucket/projects/BGT/repose2e-js-framework/browse/packages/wdio-config/docs/wdio.md#sauceconnect)) is set to true, an [ephemeral tunnel](https://docs.saucelabs.com/secure-connections/sauce-connect/proxy-tunnels/) is automatically started so connection can be stablished between Sauce Labs and your server.

    But, sometimes, your testing goals may require to have a [long-running type of tunnel](https://docs.saucelabs.com/secure-connections/sauce-connect/proxy-tunnels/) assigned meaning that, when running tests, Sauce Labs somehow needs to be informed about a connection being stablished with an already existing tunnel.

    For that, just assign the **tunnelIdentifier** property with the id of the targetted Sauce Labs tunnel to your testing capabilities:

    ```js
        const android = (exports.android = {
            platformName: "Android",
            app: join(__dirname, "../bin/AndroidWebView.apk"),
            tunnelIdentifier: 'my-tunnel-id'
        });
    ```  

--

* __sauce:options__

    Optional [Sauce Labs-specific capabilities](https://docs.saucelabs.com/dev/test-configuration-options/#desktop-and-mobile-capabilities-sauce-specific--optional) that you can use for any Sauce Labs test. They must be added to the sauce:options block of your session creation code.  

    ```js
        const android = (exports.android = {
            platformName: "Android",
            app: join(__dirname, "../bin/AndroidWebView.apk"),
            sauce:options: {
                name: testName(),
                build: buildName(),
            }
        });
    ``` 

---

Did this documentation fullfilled your expectations? If you miss something, [let us know](mailto:testing.global.group@bbva.com)!